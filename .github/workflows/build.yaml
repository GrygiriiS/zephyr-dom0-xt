name: Build

on:
  push:
    branches:
      - rpi5_dom0_dev
  pull_request_target:

env:
  sdk_version: ${{ vars.SDK_VERSION  || '0.16.5-1' }}

jobs:
  build:
    runs-on: ubuntu-22.04
    strategy:
      matrix:
        target: [rpi_5, rcar_spider_ca55, rcar_salvator_xs_m3, rcar_h3ulcb_ca57, qemu_cortex_a53]
        project: [zephyr-dom0-xt]

    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          pip install west pyelftools protobuf grpcio-tools
          sudo apt-get install ninja-build protobuf-compiler gperf

      - name: Cache Zephyr SDK
        id: cache-sdk
        uses: actions/cache@v4
        with:
          path: sdk
          key: ${{ runner.os }}-zephyr-sdk-${{ env.sdk_version }}

      - name: Download Zephyr SDK
        if: steps.cache-sdk.outputs.cache-hit != 'true'
        run: |
          mkdir sdk
          cd sdk
          wget -q https://github.com/zephyrproject-rtos/sdk-ng/releases/download/v${{ env.sdk_version }}/zephyr-sdk-${{ env.sdk_version }}_linux-x86_64.tar.xz
          tar xf zephyr-sdk-${{ env.sdk_version }}_linux-x86_64.tar.xz
          rm zephyr-sdk-${{ env.sdk_version }}_linux-x86_64.tar.xz

      - name: Install Zephyr SDK
        run: |
          cd sdk/zephyr-sdk-${{ env.sdk_version }}
          yes | ./setup.sh

      - name: Clone zephyr-dom0-xt
        uses: actions/checkout@v4
        if: matrix.project == 'zephyr-dom0-xt'
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          path: zephyr-dom0-xt

      - name: Environment setup
        run: |
          west init -l ${{ matrix.project }}
          west update

      - name: Build zephyr-dom0-xt
        if: matrix.project == 'zephyr-dom0-xt'
        run: |
          west build -p always -b ${{ matrix.target }} zephyr-dom0-xt

